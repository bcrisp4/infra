# Grafana with PostgreSQL backend defaults

# Custom ingress for Tailscale ProxyGroup
# The upstream chart's ingress doesn't support defaultBackend format
ingress:
  enabled: false
  className: tailscale
  host: ""
  annotations: {}

# CloudNativePG database configuration
database:
  # Number of PostgreSQL instances (1 for single, 2+ for HA)
  instances: 1
  storage:
    size: 5Gi
  resources:
    requests:
      cpu: 250m
      memory: 1Gi
    limits:
      memory: 1Gi
  # PostgreSQL tuning (sized for 1Gi memory allocation)
  # shared_buffers: 25% of RAM, effective_cache_size: 75% of RAM
  postgresql:
    shared_buffers: "256MB"
    effective_cache_size: "768MB"
    work_mem: "8MB"
    maintenance_work_mem: "128MB"
    # Checkpoint tuning to reduce I/O
    checkpoint_timeout: "15min"
    max_wal_size: "2GB"
    checkpoint_completion_target: "0.9"

# Database backup configuration (Barman Cloud Plugin)
backup:
  enabled: false
  # Take first backup immediately when ScheduledBackup is created
  immediate: false
  # Backup retention policy (format: XXu where u is d=days, w=weeks, m=months)
  retentionPolicy: "28d"
  s3:
    # 1Password item name for S3 credentials
    itemName: ""
    # S3 bucket name
    bucket: ""
    # S3 endpoint (without https://)
    endpoint: ""
    # Path prefix within bucket
    path: "grafana-db"

# ExternalSecret for admin credentials (1Password)
externalSecret:
  enabled: false
  itemName: ""

grafana:
  # Use admin credentials from external secret
  admin:
    existingSecret: grafana-admin
    userKey: admin-user
    passwordKey: admin-password

  # Mount CNPG-generated secret for database password
  extraSecretMounts:
    - name: db-credentials
      secretName: grafana-db-app
      mountPath: /etc/secrets/db
      readOnly: true

  grafana.ini:
    database:
      type: postgres
      host: grafana-db-rw:5432
      name: grafana
      user: grafana
      # Password from mounted secret file (CNPG-generated)
      password: $__file{/etc/secrets/db/password}
      ssl_mode: require

  # Resource defaults
  resources:
    requests:
      cpu: 100m
      memory: 128Mi
    limits:
      memory: 256Mi

  # Prometheus metrics
  podAnnotations:
    prometheus.io/scrape: "true"
    prometheus.io/port: "3000"
