# ProxyClass for HA ingress ProxyGroup with topology spread
# Does not include Linkerd injection or custom resources (blocked until operator 1.94
# due to pod-level resources bug with Kubernetes 1.34+)
apiVersion: tailscale.com/v1alpha1
kind: ProxyClass
metadata:
  name: ha-ingress
spec:
  metrics:
    enable: true
  statefulSet:
    pod:
      # Enable Prometheus scraping on metrics port
      annotations:
        prometheus.io/scrape: "true"
        prometheus.io/port: "9002"
      # Spread replicas across nodes for HA
      topologySpreadConstraints:
        - maxSkew: 1
          topologyKey: kubernetes.io/hostname
          whenUnsatisfiable: ScheduleAnyway
          labelSelector:
            matchLabels:
              app.kubernetes.io/name: tailscale
