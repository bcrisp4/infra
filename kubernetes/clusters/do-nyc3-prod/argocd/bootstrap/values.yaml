# ArgoCD configuration for do-nyc3-prod
# Update cluster.name and ingress hostname before deploying

cluster:
  name: "do-nyc3-prod"

argo-cd:
  # Global settings
  global:
    domain: argocd-do-nyc3-prod.marlin-tet.ts.net

  # ConfigMap settings
  configs:
    cm:
      admin.enabled: "true"
      # User accounts
      accounts.ben: apiKey,login
      resource.customizations.ignoreDifferences.all: |
        managedFieldsManagers:
          - kube-controller-manager
      # Ignore Istio webhook caBundle and failurePolicy (injected by istiod at runtime)
      resource.customizations.ignoreDifferences.admissionregistration.k8s.io_MutatingWebhookConfiguration: |
        jqPathExpressions:
          - .webhooks[]?.clientConfig.caBundle
          - .webhooks[]?.failurePolicy
      resource.customizations.ignoreDifferences.admissionregistration.k8s.io_ValidatingWebhookConfiguration: |
        jqPathExpressions:
          - .webhooks[]?.clientConfig.caBundle
          - .webhooks[]?.failurePolicy
      # Ignore Kubernetes-injected resourceFieldRef.divisor default
      resource.customizations.ignoreDifferences.apps_DaemonSet: |
        jqPathExpressions:
          - .spec.template.spec.containers[]?.env[]?.valueFrom.resourceFieldRef.divisor
      # Ignore noisy resources
      resource.exclusions: |
        - apiGroups:
            - ""
          kinds:
            - Endpoints
        - apiGroups:
            - cilium.io
          kinds:
            - CiliumEndpoint
            - CiliumIdentity
        - apiGroups:
            - discovery.k8s.io
          kinds:
            - EndpointSlice
        - apiGroups:
            - apps
          kinds:
            - ControllerRevision

    # RBAC policies
    rbac:
      policy.csv: |
        # Power user role - full access except sensitive admin operations
        p, role:power-user, applications, *, */*, allow
        p, role:power-user, applicationsets, *, */*, allow
        p, role:power-user, logs, get, */*, allow
        p, role:power-user, exec, create, */*, allow
        p, role:power-user, projects, *, *, allow
        p, role:power-user, repositories, *, *, allow
        p, role:power-user, certificates, *, *, allow
        # Deny sensitive operations (clusters, accounts, gpgkeys)
        # Assign ben to power-user role
        g, ben, role:power-user

    # Secrets
    # Generate hashes with: htpasswd -nbBC 10 "" 'PASSWORD' | tr -d ':\n' | sed 's/$2y/$2a/'
    secret:
      argocdServerAdminPassword: "$2a$10$poXi66TGj6uv1CCq/L0yZe1C28lByBxypBJEDyRrsOoVRsdx87cDe"
      extra:
        accounts.ben.password: "$2a$10$mSTkP.eFiPf8w1Anw6xpGuliYaBqjfN/Rbnn6rks.omekJs0FAZra"
        # GitHub webhook secret for instant sync notifications
        webhook.github.secret: "6283ab8c6eb90f91670d2d9d7223130fc1c3486ca53f9b57884be5283607c308"

  # Controller
  controller:
    replicas: 1
    resources:
      requests:
        cpu: 50m
        memory: 256Mi
      limits:
        memory: 1Gi

  # Server
  server:
    replicas: 1
    resources:
      requests:
        cpu: 25m
        memory: 64Mi
      limits:
        memory: 256Mi
    # Tailscale ingress (adjust for your setup)
    ingress:
      enabled: true
      ingressClassName: tailscale
      hostname: argocd-do-nyc3-prod
      tls: true
      annotations: {}
        # TODO: Re-enable after Tailscale operator 1.94.0 is released
        # tailscale.com/proxy-class: linkerd-mesh

  # Repo Server
  repoServer:
    replicas: 1
    resources:
      requests:
        cpu: 25m
        memory: 64Mi
      limits:
        memory: 512Mi

  # ApplicationSet Controller
  applicationSet:
    replicas: 1
    resources:
      requests:
        cpu: 25m
        memory: 32Mi
      limits:
        memory: 128Mi

  # Redis
  redis:
    resources:
      requests:
        cpu: 10m
        memory: 32Mi
      limits:
        memory: 128Mi

  # Notifications Controller
  notifications:
    enabled: true
    replicas: 1
    resources:
      requests:
        cpu: 10m
        memory: 32Mi
      limits:
        memory: 128Mi

  # Dex (disable if using external auth)
  dex:
    enabled: false
