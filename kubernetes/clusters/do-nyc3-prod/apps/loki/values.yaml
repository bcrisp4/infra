# Loki for do-nyc3-prod
# Uses DO Spaces for S3-compatible storage

externalSecret:
  enabled: true
  itemName: do-nyc3-prod-loki-s3

loki:
  loki:
    # Promote OTLP resource attributes to indexed Loki labels
    limits_config:
      otlp_config:
        resource_attributes:
          attributes_config:
            - action: index_label
              attributes:
                - cluster
                - log_source

    storage:
      bucketNames:
        chunks: ${S3_BUCKET}
        ruler: ${S3_BUCKET}
        admin: ${S3_BUCKET}
      s3:
        endpoint: ${S3_ENDPOINT}
        accessKeyId: ${AWS_ACCESS_KEY_ID}
        secretAccessKey: ${AWS_SECRET_ACCESS_KEY}

  # Component replicas for distributed mode
  ingester:
    replicas: 3
    resources:
      requests:
        cpu: 100m
        memory: 512Mi
      limits:
        memory: 1Gi
    zoneAwareReplication:
      enabled: false

  querier:
    replicas: 2
    maxUnavailable: 1
    resources:
      requests:
        cpu: 200m
        memory: 128Mi
      limits:
        memory: 512Mi

  queryFrontend:
    replicas: 2
    maxUnavailable: 1
    resources:
      requests:
        cpu: 100m
        memory: 128Mi
      limits:
        memory: 512Mi

  queryScheduler:
    replicas: 2
    resources:
      requests:
        cpu: 50m
        memory: 64Mi
      limits:
        memory: 128Mi

  distributor:
    replicas: 2
    maxUnavailable: 1
    resources:
      requests:
        cpu: 100m
        memory: 256Mi
      limits:
        memory: 512Mi

  compactor:
    replicas: 1
    resources:
      requests:
        cpu: 100m
        memory: 512Mi
      limits:
        memory: 2Gi

  indexGateway:
    replicas: 2
    maxUnavailable: 1
    resources:
      requests:
        cpu: 100m
        memory: 128Mi
      limits:
        memory: 256Mi

  lokiCanary:
    kind: Deployment
    replicas: 1
    resources:
      requests:
        cpu: 25m
        memory: 32Mi
      limits:
        memory: 64Mi

  resultsCache:
    replicas: 1
    allocatedMemory: 250
    resources:
      requests:
        cpu: 100m
        memory: 300Mi
      limits:
        memory: 300Mi

  # Chunks cache - reduced from 3Gi to fit cluster capacity
  # More cache misses will result in S3 reads (acceptable tradeoff)
  chunksCache:
    replicas: 1
    allocatedMemory: 768
    resources:
      requests:
        cpu: 100m
        memory: 1024Mi
      limits:
        memory: 1024Mi

  gateway:
    replicas: 2
    resources:
      requests:
        cpu: 50m
        memory: 32Mi
      limits:
        memory: 128Mi

  patternIngester:
    replicas: 2
    maxUnavailable: 1
    resources:
      requests:
        cpu: 100m
        memory: 256Mi
      limits:
        memory: 1Gi

  # Disable experimental bloom components
  bloomPlanner:
    replicas: 0
  bloomBuilder:
    replicas: 0
  bloomGateway:
    replicas: 0

  # Disable components not used in distributed mode
  backend:
    replicas: 0
  read:
    replicas: 0
  write:
    replicas: 0
  singleBinary:
    replicas: 0