# otel-events for do-nyc3-prod
# Collects Kubernetes events and ships to Loki via OTLP

opentelemetry-collector:
  mode: deployment
  replicaCount: 1  # Single replica to avoid duplicate events

  image:
    repository: otel/opentelemetry-collector-contrib

  # ClusterRole for watching events
  clusterRole:
    create: true
    rules:
      - apiGroups: [""]
        resources: ["events"]
        verbs: ["get", "list", "watch"]
      - apiGroups: ["events.k8s.io"]
        resources: ["events"]
        verbs: ["get", "list", "watch"]

  resources:
    requests:
      cpu: 50m
      memory: 128Mi
    limits:
      memory: 256Mi

  # Disable unused ports - only metrics for self-observability
  ports:
    jaeger-compact:
      enabled: false
    jaeger-thrift:
      enabled: false
    jaeger-grpc:
      enabled: false
    zipkin:
      enabled: false
    otlp:
      enabled: false
    otlp-http:
      enabled: false
    metrics:
      enabled: true
      containerPort: 8888
      servicePort: 8888
      protocol: TCP

  # Enable Service for metrics scraping
  service:
    enabled: true

  config:
    # Disable default receivers - we only need k8s_events
    receivers:
      jaeger: null
      otlp: null
      prometheus: null
      zipkin: null
      k8s_events:
        auth_type: serviceAccount

    # Disable default exporters, add Loki exporter
    exporters:
      debug: null
      otlphttp/loki:
        endpoint: "http://loki-gateway.loki.svc.cluster.local/otlp"
        headers:
          X-Scope-OrgID: "prod"
        retry_on_failure:
          enabled: true
          initial_interval: 5s
          max_interval: 300s
        sending_queue:
          enabled: true
          num_consumers: 5
          queue_size: 1000

    processors:
      batch:
        send_batch_size: 1000
        timeout: 5s

      memory_limiter:
        check_interval: 1s
        limit_mib: 200

      resource:
        attributes:
          - key: cluster
            value: do-nyc3-prod
            action: insert

      resource/events:
        attributes:
          - key: log_source
            value: events
            action: insert
          - key: service.name
            value: k8s-events
            action: upsert

    service:
      pipelines:
        # Disable default pipelines
        traces: null
        metrics: null
        # Only logs pipeline for events
        logs:
          receivers: [k8s_events]
          processors: [memory_limiter, resource, resource/events, batch]
          exporters: [otlphttp/loki]
