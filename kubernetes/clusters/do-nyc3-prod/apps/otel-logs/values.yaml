# otel-logs for do-nyc3-prod
# OpenTelemetry Collector DaemonSet for log collection and shipping to Loki
#
# Collects:
# - Pod logs via filelog receiver (preset)
#
# Note: Journald receiver requires journalctl binary which isn't in the
# otel-collector-contrib image. Host/systemd logs would need a custom image.

opentelemetry-collector:
  mode: daemonset

  image:
    repository: otel/opentelemetry-collector-contrib

  # Pod network (in Linkerd mesh) - no hostNetwork needed for log collection
  hostNetwork: false

  resources:
    requests:
      cpu: 100m
      memory: 128Mi
    limits:
      memory: 512Mi

  # Enable log collection presets
  presets:
    # Filelog receiver for pod logs from /var/log/pods
    logsCollection:
      enabled: true
      includeCollectorLogs: false
      storeCheckpoints: true
    # k8sattributes processor for pod metadata
    kubernetesAttributes:
      enabled: true
      extractAllPodLabels: false
      extractAllPodAnnotations: false

  # Disable unused ports
  ports:
    otlp:
      enabled: false
    otlp-http:
      enabled: false
    jaeger-compact:
      enabled: false
    jaeger-thrift:
      enabled: false
    jaeger-grpc:
      enabled: false
    zipkin:
      enabled: false
    metrics:
      enabled: true
      containerPort: 8888
      servicePort: 8888
      protocol: TCP

  # Collector configuration
  config:
    processors:
      batch:
        send_batch_size: 8192
        timeout: 5s

      memory_limiter:
        check_interval: 1s
        limit_mib: 400

      # Add cluster label to all logs
      resource:
        attributes:
          - key: cluster
            value: do-nyc3-prod
            action: insert

      # Add log_source=pods for pod logs pipeline
      resource/pods:
        attributes:
          - key: log_source
            value: pods
            action: insert

    exporters:
      # Send logs to Loki via OTLP
      otlphttp/loki:
        endpoint: "http://loki-gateway.loki.svc.cluster.local/otlp"
        headers:
          X-Scope-OrgID: "prod"
        retry_on_failure:
          enabled: true
          initial_interval: 5s
          max_interval: 300s
          max_elapsed_time: 600s
          randomization_factor: 0.5
        sending_queue:
          enabled: true
          num_consumers: 10
          queue_size: 5000

      # Debug exporter (disabled in pipelines by default)
      debug:
        verbosity: basic

    service:
      telemetry:
        logs:
          level: info
        metrics:
          address: 0.0.0.0:8888
      pipelines:
        # Pod logs pipeline (uses preset filelog receiver)
        logs:
          receivers: [filelog]
          processors: [memory_limiter, k8sattributes, resource, resource/pods, batch]
          exporters: [otlphttp/loki]
