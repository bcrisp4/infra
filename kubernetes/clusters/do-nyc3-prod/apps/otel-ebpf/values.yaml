opentelemetry-ebpf-instrumentation:
  preset: application

  # Privileged required for eBPF
  privileged: true
  securityContext:
    privileged: true

  # Resources - OBI needs significant memory for eBPF maps
  resources:
    requests:
      cpu: 100m
      memory: 256Mi
    limits:
      memory: 1Gi

  # Send to node-local collectors (internalTrafficPolicy: Local)
  config:
    data:
      otel_traces_export:
        endpoint: "http://otel-traces.otel-traces.svc.cluster.local:4317"
        # Increase queue size from default 4096 to handle bursts
        max_queue_size: 16384
        # Reduce batch timeout from 15s to flush more frequently
        batch_timeout: 5s
        # Sample 10% of traces - full volume causes queue backpressure
        sampler:
          name: parentbased_traceidratio
          arg: "0.1"
      otel_metrics_export:
        endpoint: "http://otel-metrics-push.otel-metrics-push.svc.cluster.local:4318/v1/metrics"
      attributes:
        kubernetes:
          enable: true
      prometheus_export:
        port: 9090
        path: /metrics
      # Filter out infrastructure components
      filter:
        network:
          k8s_dst_owner_name:
            not_match: '{kube*,*jaeger-agent*,*prometheus*,*promtail*,*grafana-agent*,otel-*,linkerd*}'
          k8s_src_owner_name:
            not_match: '{kube*,*jaeger-agent*,*prometheus*,*promtail*,*grafana-agent*,otel-*,linkerd*}'

  # Cluster name for k8s.cluster.name attribute
  env:
    OTEL_EBPF_KUBE_CLUSTER_NAME: do-nyc3-prod

  # Tolerate all nodes
  tolerations:
    - operator: Exists

  # Prometheus metrics
  service:
    enabled: true
    type: ClusterIP
    port: 9090
    portName: metrics
