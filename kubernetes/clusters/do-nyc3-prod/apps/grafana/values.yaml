# Grafana for do-nyc3-prod
# Uses PostgreSQL via CloudNativePG instead of SQLite

# Database HA configuration
database:
  instances: 2

# Database backup to DigitalOcean Spaces via Barman Cloud Plugin
backup:
  enabled: true
  immediate: true
  s3:
    itemName: do-nyc3-prod-grafana-postgres-s3
    bucket: bc4-do-nyc3-prod-grafana-postgres-backups
    endpoint: nyc3.digitaloceanspaces.com
    path: grafana-db

# ExternalSecret for admin credentials from 1Password
externalSecret:
  enabled: true
  itemName: do-nyc3-prod-grafana-admin

grafana:
  # HA configuration - 2 replicas with headless service for alerting peer discovery
  replicas: 2
  headlessService: true

  # Rolling update for zero-downtime deployments
  deploymentStrategy:
    type: RollingUpdate

  # Pod disruption budget - always keep at least 1 replica available
  podDisruptionBudget:
    minAvailable: 1

  # Pod IP for alerting HA peer discovery
  extraEnvs:
    - name: POD_IP
      valueFrom:
        fieldRef:
          fieldPath: status.podIP

  grafana.ini:
    server:
      domain: grafana-do-nyc3-prod.marlin-tet.ts.net
      root_url: "%(protocol)s://%(domain)s"
    feature_toggles:
      provisioning: true
      kubernetesDashboards: true
    # Alerting HA configuration
    # Uses headless service for peer discovery via memberlist gossip
    unified_alerting:
      enabled: true
      ha_listen_address: "${POD_IP}:9094"
      ha_advertise_address: "${POD_IP}:9094"
      ha_peers: grafana-headless.grafana.svc.cluster.local:9094

  # Tailscale ingress
  ingress:
    enabled: true
    ingressClassName: tailscale
    hosts:
      - grafana-do-nyc3-prod
    paths:
      - /
    tls:
      - secretName: grafana-tls
        hosts:
          - grafana-do-nyc3-prod

  # Disable chown init container (not needed with runAsNonRoot)
  initChownData:
    enabled: false

  # Resources
  resources:
    requests:
      cpu: 100m
      memory: 256Mi
    limits:
      memory: 512Mi

  # Provisioned datasources
  datasources:
    datasources.yaml:
      apiVersion: 1
      datasources:
        - name: mimir-do-nyc3-prod
          type: prometheus
          access: proxy
          url: http://mimir-gateway.mimir.svc.cluster.local/prometheus
          isDefault: true
          editable: false
          jsonData:
            prometheusType: Mimir
            prometheusVersion: 2.9.1
            timeInterval: 30s
            cacheLevel: High
            incrementalQuerying: true
            incrementalQueryOverlapWindow: 10m
            httpHeaderName1: X-Scope-OrgID
          secureJsonData:
            httpHeaderValue1: prod

  # Image renderer for PNG export, alerts, and reporting
  imageRenderer:
    enabled: true
    replicas: 1
    image:
      repository: grafana/grafana-image-renderer
      tag: latest
      pullPolicy: IfNotPresent
    env:
      HTTP_HOST: "0.0.0.0"
      # Chromium config directories
      XDG_CONFIG_HOME: /tmp/.chromium
      XDG_CACHE_HOME: /tmp/.chromium
      # Rendering timeout (default 30s may be too short for complex dashboards)
      RENDERING_VIEWPORT_MAX_WIDTH: "3000"
      RENDERING_VIEWPORT_MAX_HEIGHT: "3000"
    resources:
      requests:
        cpu: 50m
        memory: 256Mi
      limits:
        memory: 1Gi
    # Add to Linkerd mesh
    podAnnotations:
      linkerd.io/inject: enabled
    networkPolicy:
      limitIngress: true
      limitEgress: false
