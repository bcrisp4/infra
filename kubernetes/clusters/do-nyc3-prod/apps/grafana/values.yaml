# Grafana for do-nyc3-prod
# Uses PostgreSQL via CloudNativePG instead of SQLite

# Database HA configuration
database:
  instances: 2

# Database backup to DigitalOcean Spaces via Barman Cloud Plugin
backup:
  enabled: true
  immediate: true
  s3:
    itemName: do-nyc3-prod-grafana-postgres-s3
    bucket: bc4-do-nyc3-prod-grafana-postgres-backups
    endpoint: nyc3.digitaloceanspaces.com
    path: grafana-db

# ExternalSecret for admin credentials from 1Password
externalSecret:
  enabled: true
  itemName: do-nyc3-prod-grafana-admin

grafana:
  # Deployment strategy - Recreate since we have a single PG connection
  deploymentStrategy:
    type: Recreate

  grafana.ini:
    server:
      domain: grafana-do-nyc3-prod.marlin-tet.ts.net
      root_url: "%(protocol)s://%(domain)s"
    feature_toggles:
      provisioning: true
      kubernetesDashboards: true

  # Tailscale ingress
  ingress:
    enabled: true
    ingressClassName: tailscale
    hosts:
      - grafana-do-nyc3-prod
    paths:
      - /
    tls:
      - secretName: grafana-tls
        hosts:
          - grafana-do-nyc3-prod

  # Disable chown init container (not needed with runAsNonRoot)
  initChownData:
    enabled: false

  # Resources
  resources:
    requests:
      cpu: 100m
      memory: 256Mi
    limits:
      memory: 512Mi

  # Provisioned datasources
  datasources:
    datasources.yaml:
      apiVersion: 1
      datasources:
        - name: mimir-do-nyc3-prod
          uid: mimir-do-nyc3-prod
          type: prometheus
          access: proxy
          url: http://mimir-gateway.mimir.svc.cluster.local/prometheus
          isDefault: true
          editable: false
          jsonData:
            prometheusType: Mimir
            prometheusVersion: 2.9.1
            timeInterval: 30s
            cacheLevel: High
            incrementalQuerying: true
            incrementalQueryOverlapWindow: 10m
            httpHeaderName1: X-Scope-OrgID
          secureJsonData:
            httpHeaderValue1: prod
