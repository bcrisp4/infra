# Grafana for do-nyc3-prod
# Uses PostgreSQL via CloudNativePG instead of SQLite

# Database HA configuration
database:
  instances: 2

# Database backup to DigitalOcean Spaces via Barman Cloud Plugin
backup:
  enabled: true
  immediate: true
  s3:
    itemName: do-nyc3-prod-grafana-postgres-s3
    bucket: bc4-do-nyc3-prod-grafana-postgres-backups
    endpoint: nyc3.digitaloceanspaces.com
    path: grafana-db

# ExternalSecret for admin credentials from 1Password
externalSecret:
  enabled: true
  itemName: do-nyc3-prod-grafana-admin

grafana:
  # HA configuration - 2 replicas with headless service for alerting peer discovery
  replicas: 2
  headlessService: true

  # Rolling update for zero-downtime deployments
  deploymentStrategy:
    type: RollingUpdate

  # Pod disruption budget - always keep at least 1 replica available
  podDisruptionBudget:
    minAvailable: 1

  # Pod IP for alerting HA peer discovery
  extraEnvs:
    - name: POD_IP
      valueFrom:
        fieldRef:
          fieldPath: status.podIP

  grafana.ini:
    server:
      domain: grafana-do-nyc3-prod.marlin-tet.ts.net
      root_url: "%(protocol)s://%(domain)s"
    feature_toggles:
      provisioning: true
      kubernetesDashboards: true
    # Alerting HA configuration
    # Uses headless service for peer discovery via memberlist gossip
    unified_alerting:
      enabled: true
      ha_listen_address: "${POD_IP}:9094"
      ha_advertise_address: "${POD_IP}:9094"
      ha_peers: grafana-headless.grafana.svc.cluster.local:9094
    # Image rendering configuration
    rendering:
      server_url: http://grafana-image-renderer.grafana.svc.cluster.local:8081/render
      callback_url: http://grafana.grafana.svc.cluster.local/

  # Tailscale ingress
  ingress:
    enabled: true
    ingressClassName: tailscale
    hosts:
      - grafana-do-nyc3-prod
    paths:
      - /
    tls:
      - secretName: grafana-tls
        hosts:
          - grafana-do-nyc3-prod

  # Disable chown init container (not needed with runAsNonRoot)
  initChownData:
    enabled: false

  # Resources
  resources:
    requests:
      cpu: 100m
      memory: 256Mi
    limits:
      memory: 512Mi

  # Provisioned datasources
  datasources:
    datasources.yaml:
      apiVersion: 1
      datasources:
        - name: mimir-do-nyc3-prod
          type: prometheus
          access: proxy
          url: http://mimir-gateway.mimir.svc.cluster.local/prometheus
          editable: false
          jsonData:
            prometheusType: Mimir
            prometheusVersion: 2.9.1
            timeInterval: 30s
            cacheLevel: High
            incrementalQuerying: true
            incrementalQueryOverlapWindow: 10m
            httpHeaderName1: X-Scope-OrgID
          secureJsonData:
            httpHeaderValue1: prod

        - name: loki-do-nyc3-prod
          type: loki
          access: proxy
          url: http://loki-gateway.loki.svc.cluster.local
          editable: false
          jsonData:
            timeout: 60
            maxLines: 1000
            httpHeaderName1: X-Scope-OrgID
          secureJsonData:
            httpHeaderValue1: prod

        - name: tempo-do-nyc3-prod
          type: tempo
          access: proxy
          url: http://tempo-gateway.tempo.svc.cluster.local
          editable: false
          jsonData:
            httpHeaderName1: X-Scope-OrgID
            # Link to Mimir for service graph visualization
            serviceMap:
              datasourceUid: PDFDDA34E6E7D2823
            # Link to Loki for logs correlation
            tracesToLogs:
              datasourceUid: PF99E8F4CDB5B6FB2
              filterByTraceID: true
              filterBySpanID: true
            # Enable trace to metrics linking
            tracesToMetrics:
              datasourceUid: PDFDDA34E6E7D2823
          secureJsonData:
            httpHeaderValue1: prod

  # Image renderer for PNG export, alerts, and reporting
  # Enables dashboard/panel image export and alert notification images
  imageRenderer:
    enabled: true
    resources:
      requests:
        cpu: 50m
        memory: 256Mi
      limits:
        memory: 1Gi
